<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="//d2d3qesrx8xj6s.cloudfront.net/favicon.ico">
    <title>GeoHelp</title>
    <!-- Bootstrap core CSS -->
    <link href="https://bootsnipp.com/bootstrap-builder/css/editor.css" rel="stylesheet">
    <!-- Custom styles for this template -->
    <link href="https://bootsnipp.com/bootstrap-builder/demo/narrow-jumbotron/narrow-jumbotron.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Roboto:400,700,900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://preview.colorlib.com/theme/bootstrap/contact-form-20/fonts/icomoon/style.css">
    <link rel="stylesheet" href="https://preview.colorlib.com/theme/bootstrap/contact-form-20/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://preview.colorlib.com/theme/bootstrap/contact-form-20/css/style.css">
</head>
<style>
    .sightbead {
        position: relative;
        top: 10rem;
        z-index: 10;
    }

    .jumbotron {
        text-align: center;
        border-bottom: .01rem solid #e5e5e5;
        padding: 1rem 1rem;
    }

    .container {
        max-width: 85%;
        max-height: 35%;
    }
</style>

<body onload="moveOnfunc()">
    <div class="container" style="border-width: 0px; border-color: rgb(66, 133, 244); border-image: initial;">
        <div class="row">
            <div class="col-sm-4">
                <div class="col-4">
                    <h1 style="font-family: 'Lucida Sans Unicode'; font-weight: 300; text-decoration-line: underline;">
                        GeoHelp
                    </h1>
                </div>
            </div>
            <div class="col-sm-4 col-5"></div>
            <div class="col-sm-4">
                <div class="btn-group" role="group" aria-label="Basic example">
                    <button id="search_button" onclick="searchPost()" type="button" class="btn btn-secondary"
                        style="background-color: rgb(233, 152, 39);">
                        Search
                    </button>
                    <button id="post_button" onclick="newPost()" href="#bottom" type="button" class="btn btn-secondary"
                        style="background-color: rgb(46, 140, 235);left: 1rem;">
                        New Post
                    </button>
                </div>
                <div class="btn-group" role="group" aria-label="Basic example"></div>
            </div>
        </div>
    </div>
    <div class="container">
        <div class="jumbotron" style="width: 100%; height: 40%;align-self: center;">
            <div id="containerMap" style="height:30rem;min-width:40rem;position:relative;align-self:center;">
                <img src="../Webpages/component/Stage_blue.png" draggable="false" width="150" height="150"
                    class="sightbead" alt="sightbead" />
            </div>
        </div>
    </div>
    <!-- /container -->
    <div class="container">
        <div class="m-5">
            <div class="row">
                <div class="col-sm-4">
                    <div class="card">
                        <div class="card-body">
                            <h4 id="header1" class="card-title">nameVar</h4>
                            <p id="content1a" class="card-text">Here's the content</p>
                            <p id="content1b" class="card-text">contact me</p>
                        </div>
                    </div>
                </div>
                <div class="col-sm-4">
                    <div class="card">
                        <div class="card-body">
                            <h4 id="header2" class="card-title">Card title</h4>
                            <p id="content2a" class="card-text" id="location"></p>
                            <p id="content2b" class="card-text">13246821667</p>
                        </div>
                    </div>
                </div>
                <div class="col-sm-4 col-5">
                    <div class="card">
                        <div class="card-body">
                            <h4 id="header3" class="card-title">Meaningful title</h4>
                            <p id="content3a" class="card-text">Rich content</p>
                            <p id="content3b" class="card-text">no contact</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-sm-4"></div>
                <div class="col-sm-4 col-5"></div>
                <div class="col-sm-4"></div>
            </div>
        </div>
    </div>
    <form id="input_form" class="content" style="display: none;">
        <div class="container">
            <div class="row align-items-stretch justify-content-center no-gutters">
                <div class="col-md-7">
                    <div class="form h-100 contact-wrap p-5">
                        <h3 class="text-center">New Post</h3>
                        <form class="mb-5" method="post" id="contactForm" name="contactForm">
                            <div class="row">
                                <div class="col-md-6 form-group mb-3">
                                    <label for="" class="col-form-label">Title *</label>
                                    <input type="text" class="form-control" name="title" id="title"
                                        placeholder="Shout to the world" required="required">
                                </div>
                                <div class="col-md-6 form-group mb-3">
                                    <label for="" class="col-form-label">Contact Type</label>
                                    <select type="text" class="form-control" name="contact_type" id="contact_type">
                                        <option value="" selected disabled>-- Select contact type --</option>
                                        <option value="0">Phone</option>
                                        <option value="1">Email</option>
                                        <option value="2">WeChat</option>
                                        <option value="3">Weibo</option>
                                        <option value="4">Other</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12 form-group mb-3">
                                    <label for="" class="col-form-label">Contact</label>
                                    <input type="text" class="form-control" name="contact" id="contact"
                                        placeholder="How to reach you">
                                </div>
                            </div>
                            <div class="row mb-5">
                                <div class="col-md-12 form-group mb-3">
                                    <label for="message" class="col-form-label">Message *</label>
                                    <textarea class="form-control" name="content" id="content" cols="30" rows="4"
                                        placeholder="Write your message"></textarea>
                                </div>
                            </div>
                            <div class="row justify-content-center">
                                <div class="col-md-5 form-group text-center">
                                    <input value="Post" class="btn btn-block btn-primary rounded-0 py-2 px-4"
                                        onclick="submitPost()">
                                    <span class="submitting"></span>
                                </div>
                            </div>
                        </form>
                        <div id="form-message-warning mt-4"></div>
                        <div id="form-message-success">
                            Your post was published!
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
    <script type="text/javascript"
        src="https://webapi.amap.com/maps?v=1.4.15&key=e6528379c72d78afa3bbe3f6598e5516"></script>
    <script src="https://a.amap.com/jsapi_demos/static/demo-center/js/demoutils.js"></script>
    <script type="text/javascript">

        // User Vars
        var userLat = 39.9199734;
        var userLongi = 116.2391433;

        //初始化地图对象，加载地图
        var map = new AMap.Map("containerMap", {
            resizeEnable: true
        });
        var center, centerlng, centerlat, zoom, lengthOfZoom;
        var logMapinfo = function () {
            zoom = map.getZoom(); //获取当前地图级别
            center = map.getCenter(); //获取当前地图级别
            console.log(zoom.toString());
            // document.getElementById("location").innerText = center.toString();
            console.log(center);

            // get the lng and lat of the block we want
            centerlng = center[Object.keys(center)[2]]; //lng
            centerlat = center[Object.keys(center)[3]]; //lat

            console.log(centerlng + "and" + centerlat)

            if (map.getZoom() == 18) { // 3
                console.log("0.000526")
                lengthOfZoom = 0.000526;

            }
            if (map.getZoom() == 17) { // 4
                console.log("0.001041")
                lengthOfZoom = 0.001041;
            }
            if (map.getZoom() == 16) { // 5
                console.log("0.00206")
                lengthOfZoom = 0.00206;
            }
            if (map.getZoom() == 15) { // 6
                console.log("0.004377")
                lengthOfZoom = 0.004377;
            }
            if (map.getZoom() == 14) { // 7
                console.log("0.008326")
                lengthOfZoom = 0.008326;
            }
            if (map.getZoom() == 13) { // 8
                console.log("0.016822")
                lengthOfZoom = 0.016822;
            }
            if (map.getZoom() == 12) { // 9
                console.log("0.031929")
                lengthOfZoom = 0.031929;
            }
            if (map.getZoom() == 11) { // 10
                console.log("0.065227")
                lengthOfZoom = 0.065227;
            }
            if (map.getZoom() == 10) { // 11
                console.log("0.134575")
                lengthOfZoom = 0.134575;
            }
            if (map.getZoom() == 9) { // 12
                console.log("0.269165")
                lengthOfZoom = 0.269165;
            }
            if (map.getZoom() == 8) { // 14
                console.log("0.55481")
                lengthOfZoom = 0.55481;
            }
            if (map.getZoom() == 7) { // 15
                console.log("1.10962")
                lengthOfZoom = 1.10962;
            }
            if (map.getZoom() == 6) { // 16
                console.log("2.21924")
                lengthOfZoom = 2.21924;
            }
            if (map.getZoom() == 5) { // 17
                console.log("4.43848")
                lengthOfZoom = 4.43848;
            }
            if (map.getZoom() == 4) { // 18
                console.log("8.87696")
                lengthOfZoom = 8.87696;
            }
            if (map.getZoom() == 3) { // 18
                console.log("17.75392")
                lengthOfZoom = 17.75392;
            }
        };
        logMapinfo();

        function mapMovestart() {
            // document.querySelector("#text").innerText = '地图移动开始';
        }
        function mapMove() {
            logMapinfo();
            // document.querySelector("#text").innerText = '地图正在移动';
        }
        function mapMoveend() {
            // document.querySelector("#text").innerText = '地图移动结束';
        }
        // 事件绑定
        function moveOnfunc() {
            log.success("欢迎！");
            map.on('movestart', mapMovestart);
            map.on('mapmove', mapMove);
            map.on('moveend', mapMoveend);
        }

        function moveOnfunc2() {
            log.success("继续");
            map.on('movestart', mapMovestart);
            map.on('mapmove', mapMove);
            map.on('moveend', mapMoveend);
        }

        var postInfo;
        var postId = [];
        /*
         * - 请求方式：POST
         * - 请求路径：/viewer/queryPostsID
         * - 请求参数： centerLat, centerLongi, length
         */
        function searchPost() {
            console.log(center);
            console.log("req: " + JSON.stringify({ centerLat: centerlat, centerLongi: centerlng, length: lengthOfZoom }));
            // pass to backend
            $.ajax({
                type: "POST",
                url: 'http://cacheuseonly.tpddns.cn:8080/viewer/queryPostsID',
                data: JSON.stringify({ centerLat: centerlat, centerLongi: centerlng, length: lengthOfZoom }),
                contentType: "application/json",
                success: function (data) {
                    console.log(data);
                    var searched = JSON.parse(data);    // parsed the returned data
                    postInfo = searched['result'];

                    // only get the post_id section
                    for (var i = 0; i < postInfo.length; i++) {
                        postId.push(postInfo[i]['post_id']);
                    }

                    if (searched['status'] == 0) {      // search success, TODO: can add the fail case
                        updateCards();
                    }
                },
                error: function (jqxhr) {
                    console.log("Failed")
                    console.log(jqxhr)
                },
                async: false
            });
        }

        /*
         * - 请求方式：POST
         * - 请求路径：/viewer/queryPostDetail
         * - 请求参数： post_id
         */
        var searchedPostHeader = [];
        var searchedPostContent = [];
        var searchedPostContact = [];
        var length = 3;
        var finished = false;
        async function queryPostDetail() {
            console.log("queryPostDetail() called");
            // for each element in the postInfo, query the detail
            for (var i = 0; i < postId.length; i++) {
                console.log(postId[i]);
                // pass to backend
                $.ajax({
                    type: "POST",
                    url: 'http://cacheuseonly.tpddns.cn:8080/viewer/queryPostDetail',
                    data: JSON.stringify({ post_id: postId[i] }),
                    contentType: "application/json",
                    success: function (data) {
                        console.log(data);
                        var content = JSON.parse(data);
                        searchedPostHeader.push(content['result']['title']);
                        searchedPostContent.push(content['result']['content']);
                        searchedPostContact.push(content['result']['contact']);
                        length = length + 1;
                        console.log("length: ", length)
                    },
                    error: function (jqxhr) {
                        console.log(jqxhr)
                    },
                    async:false
                });
            }

            finished = true;
        }

        async function updateCards() {
            await queryPostDetail();
            console.log("updateCards() called")
            // update the cards
            if (length == 0) {
                document.getElementById("header1").innerHTML = "no post";
                document.getElementById("content1a").innerHTML = "no content";
                document.getElementById("content1b").innerHTML = "no content";

                document.getElementById("header2").innerHTML = "no post";
                document.getElementById("content2a").innerHTML = "no content";
                document.getElementById("content2b").innerHTML = "no content";

                document.getElementById("header3").innerHTML = "no post";
                document.getElementById("content3a").innerHTML = "no content";
                document.getElementById("content3b").innerHTML = "no content";
            }

            if (length == 1) {
                document.getElementById("header1").innerHTML = searchedPostHeader[0];
                document.getElementById("content1a").innerHTML = searchedPostContent[0];
                document.getElementById("content1b").innerHTML = searchedPostContact[0];

                document.getElementById("header2").innerHTML = "no post";
                document.getElementById("content2a").innerHTML = "no content";
                document.getElementById("content2b").innerHTML = "no content";

                document.getElementById("header3").innerHTML = "no post";
                document.getElementById("content3a").innerHTML = "no content";
                document.getElementById("content3b").innerHTML = "no content";
            }

            if (length == 2) {
                document.getElementById("header1").innerHTML = searchedPostHeader[0];
                document.getElementById("content1a").innerHTML = searchedPostContent[0];
                document.getElementById("content1b").innerHTML = searchedPostContact[0];

                document.getElementById("header2").innerHTML = searchedPostHeader[1];
                document.getElementById("content2a").innerHTML = searchedPostContent[1];
                document.getElementById("content2b").innerHTML = searchedPostContact[1];

                document.getElementById("header3").innerHTML = "no post";
                document.getElementById("content3a").innerHTML = "no content";
                document.getElementById("content3b").innerHTML = "no content";
            }

            if (length >= 3) {
                console.log("header", searchedPostHeader)
                console.log("content", searchedPostContent)
                console.log("contact", searchedPostContact)
                document.getElementById("header1").innerHTML = searchedPostHeader[0];
                document.getElementById("content1a").innerHTML = searchedPostContent[0];
                document.getElementById("content1b").innerHTML = searchedPostContact[0];

                document.getElementById("header2").innerHTML = searchedPostHeader[1];
                document.getElementById("content2a").innerHTML = searchedPostContent[1];
                document.getElementById("content2b").innerHTML = searchedPostContact[1];

                document.getElementById("header2").innerHTML = searchedPostHeader[2];
                document.getElementById("content2a").innerHTML = searchedPostContent[2];
                document.getElementById("content2b").innerHTML = searchedPostContact[2];
            }
        }

        /*
         * - 请求方式：POST
         * - 请求路径：/poster/newPost
         * - 请求参数: latitude, longitude, title, content, contact, contact_type
         */
        function onSuccuess(pos) {
            console.log("getLocation succuess")
            var crd = pos.coords;
            userLat = crd.latitude;
            userLongi = crd.longitude;
            console.log(`User latitude: ${userLat}, longitude: ${userLongi}`)
        }
        function onFail(err) {
            console.log("getLocation failed")
            console.warn(`Error ${err.code}: ${err.message}`)
        }
        function newPost() {
            window.navigator.geolocation.getCurrentPosition(onSuccuess, onFail, {
                enableHighAccuracy: true,
                timeout: 5000,
                maximumAge: 0
            })

            document.getElementById("input_form").style.display = "";
            $("html, body").animate({ scrollTop: $(document).height() }, 1200);
        }

        function submitPost() {
            var formData = new FormData();
            formData.append("title", document.getElementById("title").value);
            formData.append("content", document.getElementById("content").value);
            formData.append("contact", document.getElementById("contact").value);
            formData.append("contact_type", document.getElementById("contact_type").value);
            formData.append("latitude", userLat)
            formData.append("longitude", userLongi)

            var reqBody = {};
            formData.forEach(function (value, key) {
                reqBody[key] = value;
            });
            console.log("reqBody: " + JSON.stringify(reqBody));

            $.ajax({
                type: "POST",
                url: 'http://cacheuseonly.tpddns.cn:8080/poster/newPost',
                data: JSON.stringify(reqBody),
                contentType: "application/json",
                success: function (data) {
                    console.log(data);

                },
                error: function (jqxhr) {
                    console.log("Failed")
                    console.log(jqxhr)
                }
            });

            $("html, body").animate({ scrollTop: -$(document).height() }, 1200);
            document.getElementById("input_form").style.display = "none";
        }
        // 解绑事件
        function moveOfffunc() {
            log.success("自由浏览模式!");
            map.off('movestart', mapMovestart);
            map.off('mapmove', mapMove);
            map.off('moveend', mapMoveend);
        }
        // 给按钮绑定事件
        // document.getElementById("moveOn").onclick = moveOnfunc2;
        // document.getElementById("moveOff").onclick = moveOfffunc;
        document.getElementById("post_button").onClick = newPost;
    </script>

    <script src="https://preview.colorlib.com/theme/bootstrap/contact-form-20/js/jquery-3.3.1.min.js"></script>
    <script src="https://preview.colorlib.com/theme/bootstrap/contact-form-20/js/popper.min.js"></script>
    <script src="https://preview.colorlib.com/theme/bootstrap/contact-form-20/js/bootstrap.min.js"></script>
    <script src="https://preview.colorlib.com/theme/bootstrap/contact-form-20/js/jquery.validate.min.js"></script>
    <script src="https://preview.colorlib.com/theme/bootstrap/contact-form-20/js/main.js"></script>
    <script defer src="https://static.cloudflareinsights.com/beacon.min.js"
        data-cf-beacon='{"rayId":"67b2588e88de3104","token":"cd0b4b3a733644fc843ef0b185f98241","version":"2021.7.0","si":10}'></script>
</body>

</html>